<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Toggling | Yiming @ SeasonsRoad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="In one of the first chapters we talked about how to set options in Vim.  For boolean options we can use set someoption! to “toggle” the option.  This is especially nice when we create a mapping for th">
<meta property="og:type" content="website">
<meta property="og:title" content="Toggling">
<meta property="og:url" content="http://seasonsroad.com/LearnVimScriptTheHardWay/38.html">
<meta property="og:site_name" content="Yiming @ SeasonsRoad">
<meta property="og:description" content="In one of the first chapters we talked about how to set options in Vim.  For boolean options we can use set someoption! to “toggle” the option.  This is especially nice when we create a mapping for th">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Toggling">
<meta name="twitter:description" content="In one of the first chapters we talked about how to set options in Vim.  For boolean options we can use set someoption! to “toggle” the option.  This is especially nice when we create a mapping for th">
  
    <link rel="alternative" href="/atom.xml" title="Yiming @ SeasonsRoad" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-nav" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Good Morning!</a>
      </h1>
      <nav id="main-nav">
        <ul class="mod-head__ul">
        
          <li class="main-nav-link"><a href="/">Home</a></li>
        
          <li class="main-nav-link"><a href="/links.html">Links</a></li>
        
          <li class="main-nav-link"><a href="https://github.com/yiminglu">Github</a></li>
        
          <li class="main-nav-link"><a href="/about.html">About</a></li>
        
        </ul>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="inner">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      <a href="/LearnVimScriptTheHardWay/38.html">
        Toggling
      </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In one of the first chapters we talked about how to set options in Vim.  For boolean options we can use <code>set someoption!</code> to “toggle” the option.  This is especially nice when we create a mapping for that command.</p>
<p>Run the following command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:nnoremap &lt;leader&gt;N :setlocal number!&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>Try it out by pressing <code>&lt;leader&gt;N</code> in normal mode.  Vim will toggle the line numbers for the current window off and on.  Creating a “toggle” mapping like this is really handy, because we don’t need to have two separate keys to turn something off and on.</p>
<p>Unfortunately this only works for boolean options.  If we want to toggle a non-boolean option we’ll need to do a bit more work.</p>
<h2 id="Toggling_Options">Toggling Options</h2><p>Let’s start by creating a function that will toggle an option for us, and a mapping that will call it.  Put the following into your <code>~/.vimrc</code> file (or a separate file in <code>~/.vim/plugin/</code> if you prefer):</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;f :call FoldColumnToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! FoldColumnToggle()</span><br><span class="line"></span><br><span class="line">echom &amp;foldcolumn</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Write and source the file, then try it out by pressing <code>&lt;leader&gt;f</code>  Vim will display the current value of the <code>foldcolumn</code> option.  Go ahead and read <code>:help foldcolumn</code> if you’re unfamiliar with this option.</p>
<p>Let’s add in the actual toggling functionality.  Edit the code to look like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;f :call FoldColumnToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! FoldColumnToggle()</span><br><span class="line"></span><br><span class="line">if &amp;foldcolumn</span><br><span class="line"></span><br><span class="line">    setlocal foldcolumn=0</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">    setlocal foldcolumn=4</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Write and source the file and try it out.  Each time you press it Vim will either show or hide the fold column.</p>
<p>The <code>if</code> statement simply checks if <code>&amp;foldcolumn</code> is truthy (remember that Vim treats the integer 0 as falsy and any other number as truthy).  If so, it sets it to zero (which hides it).  Otherwise it sets it to four.  Pretty simple.</p>
<p>You can use a simple function like this to toggle any option where <code>0</code> means “off” and any other number is “on”.</p>
<h2 id="Toggling_Other_Things">Toggling Other Things</h2><p>Options aren’t the only thing we might want to toggle.  One particularly nice thing to have a mapping for is the quickfix window.  Let’s start with the same skeleton as before.  Add the following code to your file:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;q :call QuickfixToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! QuickfixToggle()</span><br><span class="line"></span><br><span class="line">return</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>This mapping doesn’t do anything yet.  Let’s transform it into something slightly more useful (but not completely finished yet).  Change the code to look like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;q :call QuickfixToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! QuickfixToggle()</span><br><span class="line"></span><br><span class="line">copen</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Write and source the file.  If you try out the mapping now you’ll see that it simply opens the quickfix window.</p>
<p>To get the “toggling” behavior we’re looking for we’ll use a quick, dirty solution: a global variable.  Change the code to look like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;q :call QuickfixToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! QuickfixToggle()</span><br><span class="line"></span><br><span class="line">if g:quickfix_is_open</span><br><span class="line"></span><br><span class="line">    cclose</span><br><span class="line"></span><br><span class="line">    let g:quickfix_is_open = 0</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">    copen</span><br><span class="line"></span><br><span class="line">    let g:quickfix_is_open = 1</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>What we’ve done is pretty simple — we’re simply storing a global variable describing the open/closed state of the quickfix window whenever we call the function.</p>
<p>Write and source the file, and try to run the mapping.  Vim will complain that the variable is not defined yet!  Let’s fix that by initializing it once:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;q :call QuickfixToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">let g:quickfix_is_open = 0</span><br><span class="line"></span><br><span class="line">function! QuickfixToggle()</span><br><span class="line"></span><br><span class="line">if g:quickfix_is_open</span><br><span class="line"></span><br><span class="line">    cclose</span><br><span class="line"></span><br><span class="line">    let g:quickfix_is_open = 0</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">    copen</span><br><span class="line"></span><br><span class="line">    let g:quickfix_is_open = 1</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Write and source the file, and try the mapping.  It works!</p>
<h2 id="Improvements">Improvements</h2><p>Our toggle function works, but has a few problems.</p>
<p>The first is that if the user manually opens or closes the window with <code>:copen</code> or <code>:cclose</code> our global variable doesn’t get updated.  This isn’t really a huge problem in practice because most of the time the user will probably be opening the window with the mapping, and if not they can always just press it again.</p>
<p>This illustrates an important point about writing Vimscript code: if you try to handle every single edge case you’ll get bogged down in it and never get any work done.</p>
<p>Getting something that works most of the time (and doesn’t explode when it doesn’t work) and getting back to coding is usually better than spending hours getting it 100% perfect.  The exception is when you’re writing a plugin you expect many people to use.  In that case it’s best to spend the time and make it bulletproof to keep your users happy and reduce bug reports.</p>
<h2 id="Restoring_Windows/Buffers">Restoring Windows/Buffers</h2><p>The other problem with our function is that if the user runs the mapping when they’re already in the quickfix window, Vim closes it and dumps them into the last split instead of sending them back where they were.  This is annoying if you just want to check the quickfix window really quick and get back to working.</p>
<p>To solve this we’ll introduce an idiom that comes in handy a lot when writing Vim plugins.  Edit your code to look like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;q :call QuickfixToggle()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">let g:quickfix_is_open = 0</span><br><span class="line"></span><br><span class="line">function! QuickfixToggle()</span><br><span class="line"></span><br><span class="line">if g:quickfix_is_open</span><br><span class="line"></span><br><span class="line">    cclose</span><br><span class="line"></span><br><span class="line">    let g:quickfix_is_open = 0</span><br><span class="line"></span><br><span class="line">    execute g:quickfix_return_to_window . "wincmd w"</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">    let g:quickfix_return_to_window = winnr()</span><br><span class="line"></span><br><span class="line">    copen</span><br><span class="line"></span><br><span class="line">    let g:quickfix_is_open = 1</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>We’ve added two new lines in this mapping.  One of them (in the <code>else</code> clause) sets another global variable which saves the current window number before we run <code>:copen</code>.</p>
<p>The second line (in the <code>if</code> clause) executes <code>wincmd w</code> with that number prepended as a count, which tells Vim to go to that window.</p>
<p>Once again our solution isn’t bulletproof, because the user might open or close new split between runs of the mapping.  Even so, it handles the majority of cases so it’s good enough for now.</p>
<p>This strategy of manually saving global state would be frowned upon in most serious programs, but for tiny little Vimscript functions it’s a quick and dirty way of getting something mostly working and moving on with your life.</p>
<h2 id="Exercises">Exercises</h2><p>Read <code>:help foldcolumn</code>.</p>
<p>Read <code>:help winnr()</code></p>
<p>Read <code>:help ctrl-w_w</code>.</p>
<p>Read <code>:help wincmd</code>.</p>
<p>Namespace the functions by adding <code>s:</code> and <code>&lt;SID&gt;</code> where necessary.</p>
<p><a href="37.html">« Previous</a><a style="float:right" href="39.html">Next »</a></p>

      
    </div>
    
  </div>
  
</article>


</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
	<div id="footer-info" class="inner">
	&copy; 2015 Yiming LU<br>
	Hosted on <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
	</div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'ymlu';
  
  var disqus_url = 'http://seasonsroad.com/LearnVimScriptTheHardWay/38.html';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

  </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>More Operator-Pending Mappings | Yiming @ SeasonsRoad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The idea of operators and movements is one of the most important concepts in Vim, and it’s one of the biggest reasons Vim is so efficient.  We’re going to practice defining new motions a bit more, bec">
<meta property="og:type" content="website">
<meta property="og:title" content="More Operator-Pending Mappings">
<meta property="og:url" content="http://seasonsroad.com/LearnVimScriptTheHardWay/16.html">
<meta property="og:site_name" content="Yiming @ SeasonsRoad">
<meta property="og:description" content="The idea of operators and movements is one of the most important concepts in Vim, and it’s one of the biggest reasons Vim is so efficient.  We’re going to practice defining new motions a bit more, bec">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="More Operator-Pending Mappings">
<meta name="twitter:description" content="The idea of operators and movements is one of the most important concepts in Vim, and it’s one of the biggest reasons Vim is so efficient.  We’re going to practice defining new motions a bit more, bec">
  
    <link rel="alternative" href="/atom.xml" title="Yiming @ SeasonsRoad" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-nav" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Good Morning!</a>
      </h1>
      <nav id="main-nav">
        <ul class="mod-head__ul">
        
          <li class="main-nav-link"><a href="/">Home</a></li>
        
          <li class="main-nav-link"><a href="/links.html">Links</a></li>
        
          <li class="main-nav-link"><a href="https://github.com/yiminglu">Github</a></li>
        
          <li class="main-nav-link"><a href="http://weibo.com/u/2168765080">Weibo</a></li>
        
          <li class="main-nav-link"><a href="/about.html">About</a></li>
        
        </ul>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="inner">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      <a href="/LearnVimScriptTheHardWay/16.html">
        More Operator-Pending Mappings
      </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The idea of operators and movements is one of the most important concepts in Vim, and it’s one of the biggest reasons Vim is so efficient.  We’re going to practice defining new motions a bit more, because extending this powerful idea makes Vim even <em>more</em> powerful.</p>
<p>Let’s say you’re writing some text in Markdown.  If you haven’t used Markdown before, don’t worry, for our purposes here it’s very simple.  Type the following into a file:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Topic One</span><br><span class="line"></span><br><span class="line">=========</span><br><span class="line"></span><br><span class="line">This is some text about topic one.</span><br><span class="line"></span><br><span class="line">It has multiple paragraphs.</span><br><span class="line"></span><br><span class="line">Topic Two</span><br><span class="line"></span><br><span class="line">=========</span><br><span class="line"></span><br><span class="line">This is some text about topic two.  It has only one paragraph.</span><br></pre></td></tr></table></figure>
<p>The lines “underlined” with <code>=</code> characters are treated as headings by Markdown. Let’s create some mappings that let us target headings with movements.  Run the following command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:onoremap ih :&lt;c-u&gt;execute "normal! ?^==\\+$\r:nohlsearch\rkvg_"&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>This mapping is pretty complicated, so put your cursor in one of the paragraphs (not the headings) and type <code>cih</code>.  Vim will delete the heading of whatever section you’re in and put you in insert mode (“change inside heading”).</p>
<p>It uses some things we’ve never seen before, so let’s look at each piece individually.  The first part of the mapping, <code>:onoremap ih</code> is just the mapping command that we’ve seen before, so we’ll skip over that.  We’ll keep ignoring the <code>&lt;c-u&gt;</code> for the moment as well.</p>
<p>Now we’re looking at the remainder of the line:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:execute "normal! ?^==\\+$\r:nohlsearch\rkvg_"&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Normal">Normal</h2><p>The <code>:normal</code> command takes a set of characters and performs whatever action they would do if they were typed in normal mode.  We’ll go into greater detail in a later chapter, but we’ve seen it a few times already so it’s time to at least get a taste.  Run this command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:normal gg</span><br></pre></td></tr></table></figure>
<p>Vim will move you to the top of the file.  Now run this command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:normal &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Vim will indent the current line.</p>
<p>For now, don’t worry about the <code>!</code> after <code>normal</code> in our mapping.  We’ll talk about that later.</p>
<h2 id="Execute">Execute</h2><p>The <code>execute</code> command takes a Vimscript string (which we’ll cover in more detail later) and performs it as a command.  Run this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:execute "write"</span><br></pre></td></tr></table></figure>
<p>Vim will write your file, just as if you had typed <code>:write&lt;cr&gt;</code>.  Now run this command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:execute "normal! gg"</span><br></pre></td></tr></table></figure>
<p>Vim will run <code>:normal! gg</code>, which as we just saw will move you to the top of the file.  But why bother with this when we could just run the <code>normal!</code> command itself?</p>
<p>Look at the following command and try to guess what it will do:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:normal! gg/a&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>It seems like it should:</p>
<ul>
<li>Move to the top of the file. <em> Start a search. </em> Fill in “a” as the target to search for. * Press return to perform the search.</li>
</ul>
<p>Run it.  Vim will move to the top of the file and nothing else!</p>
<p>The problem is that <code>normal!</code> doesn’t recognize “special characters” like <code>&lt;cr&gt;</code>.  There are a number of ways around this, but the easiest to use and read is <code>execute</code>.</p>
<p>When <code>execute</code> looks at the string you tell it to run, it will substitute any special characters it finds <em>before</em> running it.  In this case, <code>\r</code> is an escape sequence that means “carriage return”.  The double backslash is also an escape sequence that puts a literal backslash in the string.</p>
<p>If we perform this replacement in our mapping and look at the result we can see that the mapping is going to perform:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:normal!</span> ?^==\+<span class="variable">$&lt;</span>cr&gt;<span class="symbol">:nohlsearch&lt;cr&gt;kvg_</span></span><br><span class="line"></span><br><span class="line">            ^^^^           ^^^^</span><br><span class="line"></span><br><span class="line">             ||             ||</span><br><span class="line"></span><br><span class="line"><span class="constant">These </span>are <span class="constant">ACTUAL </span>carriage returns, <span class="constant">NOT </span>the four characters</span><br><span class="line"></span><br><span class="line"><span class="string">"left angle bracket"</span>, <span class="string">"c"</span>, <span class="string">"r"</span>, <span class="keyword">and</span> <span class="string">"right angle bracket"</span>.</span><br></pre></td></tr></table></figure>
<p>So now <code>normal!</code> will execute these characters as if we had typed them in normal mode.  Let’s split them apart at the returns to find out what they’re doing:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?^==\+$</span><br><span class="line"></span><br><span class="line">:nohlsearch</span><br><span class="line"></span><br><span class="line">kvg_</span><br></pre></td></tr></table></figure>
<p>The first piece, <code>?^==\+$</code> performs a search backwards for any line that consists of two or more equal signs and nothing else. This will leave our cursor on the first character of the line of equal signs.</p>
<p>We’re searching backwards because when you say “change inside heading” while your cursor is in a section of text, you probably want to change the heading for <em>that</em> section, not the next one.</p>
<p>The second piece is the <code>:nohlsearch</code> command.  This simply clears the search highlighting from the search we just performed so it’s not distracting.</p>
<p>The final piece is a sequence of three normal mode commands:</p>
<ul>
<li><code>k</code>: move up a line.  Since we were on the first character of the line of<br>equal signs, we’re now on the first character of the heading text. <em> <code>v</code>: enter (characterwise) visual mode. </em> <code>g_</code>: move to the last non-blank character of the current line.  We use this<br>instead of <code>$</code> because <code>$</code> would highlight the newline character as well, and<br>this isn’t what we want.</li>
</ul>
<h2 id="Results">Results</h2><p>That was a lot of work, but now we’ve looked at each part of the mapping.  To recap:</p>
<ul>
<li>We created a operator-pending mapping for “inside this section’s heading”. <em> We used <code>execute</code> and <code>normal!</code> to run the normal commands we needed to select<br>the heading, and allowing us to use special characters in those. </em> Our mapping searches for the line of equal signs which denotes a heading and<br>visually selects the heading text above that. * Vim handles the rest.</li>
</ul>
<p>Let’s look at one more mapping before we move on.  Run the following command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:onoremap ah :&lt;c-u&gt;execute "normal! ?^==\\+\r:nohlsearch\rg_vk0"&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>Try it by putting your cursor in a section’s text and typing <code>cah</code>.  This time Vim will delete not only the heading’s text but also the line of equal signs that denotes a heading.  You can think of this movement as “<em>around</em> this section’s heading”.</p>
<p>What’s different about this mapping?  Let’s look at them side by side:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:onoremap ih :&lt;c-u&gt;execute "normal! ?^==\\+$\r:nohlsearch\rkvg_"&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">:onoremap ah :&lt;c-u&gt;execute "normal! ?^==\\+$\r:nohlsearch\rg_vk0"&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>The only difference from the previous mapping is the very end, where we select the text to operate on:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inside <span class="string">heading:</span> kvg_</span><br><span class="line"></span><br><span class="line">around <span class="string">heading:</span> g_vk0</span><br></pre></td></tr></table></figure>
<p>The rest of the mapping is the same, so we still start on the first character of the line of equal signs.  From there:</p>
<ul>
<li><code>g_</code>: move to the last non-blank character in the line. <em> <code>v</code>: enter (characterwise) visual mode. </em> <code>k</code>: move up a line.  This puts us on the line containing the heading’s text. * <code>0</code>: move to the first character of the line.</li>
</ul>
<p>The result is that both the text and the equal signs end up visually selected, and Vim performs the operation on both.</p>
<h2 id="Exercises">Exercises</h2><p>Markdown can also have headings delimited with lines of <code>-</code> characters.  Adjust the regex in these mappings to work for either type of heading.  You may want to check out <code>:help pattern-overview</code>.  Remember that the regex is inside of a string, so backslashes will need to be escaped.</p>
<p>Add two autocommands to your <code>~/.vimrc</code> file that will create these mappings. Make sure to only map them in the appropriate buffers, and make sure to group them so they don’t get duplicated each time you source the file.</p>
<p>Read <code>:help normal</code>.</p>
<p>Read <code>:help execute</code>.</p>
<p>Read <code>:help expr-quote</code> to see the escape sequences you can use in strings.</p>
<p>Create a “inside next email address” operator-pending mapping so you can say “change inside next email address”.  <code>in@</code> is a good candidate for the keys to map. You’ll probably want to use <code>/...some regex...&lt;cr&gt;</code> for this.</p>
<p><a href="15.html">« Previous</a><a style="float:right" href="17.html">Next »</a></p>

      
    </div>
    <footer class="article-footer">
      
    </footer>
  </div>
  
</article>

</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
	<div id="footer-info" class="inner">
	&copy; 2015 Yiming LU<br>
	Hosted on <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
	</div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'ymlu';
  
  var disqus_url = 'http://seasonsroad.com/LearnVimScriptTheHardWay/16.html';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

  </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Autoloading | Yiming @ SeasonsRoad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="We’ve written a fair amount of functionality for our Potion plugin, and that’s all we’re going to do in this book.  Before we finish we’ll talk about a few more important ways to polish it up and real">
<meta property="og:type" content="website">
<meta property="og:title" content="Autoloading">
<meta property="og:url" content="http://seasonsroad.com/LearnVimScriptTheHardWay/53.html">
<meta property="og:site_name" content="Yiming @ SeasonsRoad">
<meta property="og:description" content="We’ve written a fair amount of functionality for our Potion plugin, and that’s all we’re going to do in this book.  Before we finish we’ll talk about a few more important ways to polish it up and real">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Autoloading">
<meta name="twitter:description" content="We’ve written a fair amount of functionality for our Potion plugin, and that’s all we’re going to do in this book.  Before we finish we’ll talk about a few more important ways to polish it up and real">
  
    <link rel="alternative" href="/atom.xml" title="Yiming @ SeasonsRoad" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-nav" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Good Morning!</a>
      </h1>
      <nav id="main-nav">
        <ul class="mod-head__ul">
        
          <li class="main-nav-link"><a href="/">Home</a></li>
        
          <li class="main-nav-link"><a href="/links.html">Links</a></li>
        
          <li class="main-nav-link"><a href="https://github.com/yiminglu">Github</a></li>
        
          <li class="main-nav-link"><a href="/about.html">About</a></li>
        
        </ul>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="inner">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      <a href="/LearnVimScriptTheHardWay/53.html">
        Autoloading
      </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>We’ve written a fair amount of functionality for our Potion plugin, and that’s all we’re going to do in this book.  Before we finish we’ll talk about a few more important ways to polish it up and really make it shine.</p>
<p>First on the list is making our plugin more efficient with autoloading.</p>
<h2 id="How_Autoload_Works">How Autoload Works</h2><p>Currently when a user loads our plugin (by opening a Potion file) <em>all</em> of its functionality is loaded.  Our plugin is still small so this probably isn’t a big deal, but for larger plugins loading all of their code can take a noticeable amount of time.</p>
<p>Vim’s solution to this is something called “autoload”.  Autoload lets you delay loading code until it’s actually needed.  You’ll take a slight performance hit overall, but if your users don’t always use every single bit of code in your plugin autoloading can be a huge speedup.</p>
<p>Here’s how it works.  Look at the following command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:call somefile#Hello()</span><br></pre></td></tr></table></figure>
<p>When you run this command, Vim will behave a bit differently than a normal function call.</p>
<p>If this function has already been loaded, Vim will simply call it normally.</p>
<p>Otherwise Vim will look for a file called <code>autoload/somefile.vim</code> in your <code>~/.vim</code> directory (and any Pathogen bundles).</p>
<p>If this file exists, Vim will load/source the file.  It will then try to call the function normally.</p>
<p>Inside this file, the function should be defined like this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">somefile</span>#<span class="title">Hello</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="string">" ...</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>You can use multiple <code>#</code> characters in the function name to represent subdirectories.  For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:call myplugin#somefile#Hello()</span><br></pre></td></tr></table></figure>
<p>This will look for the autoloaded file at <code>autoload/myplugin/somefile.vim</code>.  The function inside it needs to be defined with the full autoload path:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myplugin</span>#<span class="title">somefile</span>#<span class="title">Hello</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="string">" ...</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<h2 id="Experimenting">Experimenting</h2><p>To get a feel for how this works, let’s give it a try.  Create a <code>~/.vim/autoload/example.vim</code> file and add the following to it:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echom</span> <span class="string">"Loading..."</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">example</span>#<span class="title">Hello</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echom</span> <span class="string">"Hello, world!"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echom</span> <span class="string">"Done loading."</span></span><br></pre></td></tr></table></figure>
<p>Save the file and run <code>:call example#Hello()</code>.  Vim will output the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loading...&#10;&#10;Done loading.&#10;&#10;Hello, world!</span><br></pre></td></tr></table></figure>
<p>This little demonstration proves a few things:</p>
<ol>
<li>Vim really does load the <code>example.vim</code> file on the fly.  It didn’t even exist<br>when we opened Vim, so it couldn’t have been loaded on startup! 2. When Vim finds the file it needs to autoload, it loads the entire file before<br>actually calling the function.</li>
</ol>
<p><strong>Without closing Vim</strong>, change the definition of the function to look like this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echom</span> <span class="string">"Loading..."</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">example</span>#<span class="title">Hello</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echom</span> <span class="string">"Hello AGAIN, world!"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echom</span> <span class="string">"Done loading."</span></span><br></pre></td></tr></table></figure>
<p>Save the file and <strong>without closing Vim</strong> run <code>:call example#Hello()</code>.  Vim will simply output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>Vim already has a definition for <code>example#Hello</code>, so it doesn’t need to reload the file, which means:</p>
<ol>
<li>The code outside the function wasn’t run again. 2. It didn’t pick up the changes to the function.</li>
</ol>
<p>Now run <code>:call example#BadFunction()</code>.  You’ll see the loading messages again, as well as an error about a nonexistent function.  But now try running <code>:call example#Hello()</code> again.  This time you’ll see the updated message!</p>
<p>By now you should have a pretty clear grip on what happens when Vim encounters a call to a function with an autoload-style name:</p>
<ol>
<li>It checks to see if it has a function by that name defined already.  If so,<br>just call it. 2. Otherwise, find the appropriate file (based on the name) and source it. 3. Then attempt to call the function.  If it works, great. If it fails, just<br>print an error.</li>
</ol>
<p>If that’s not completely solid in your mind yet, go back and work through this demonstration again and try to see where each rule takes effect.</p>
<h2 id="What_to_Autoload">What to Autoload</h2><p>Autoloading isn’t free.  There’s some (small) overhead involved with setting it up, not to mention the ugly function names you need to sprinkle through your code.</p>
<p>With that said, if you’re creating a plugin that won’t be used <em>every</em> time a user opens a Vim session it’s probably a good idea to move as much functionality into autoloaded files as possible.  This will reduce the impact your plugin has on your users’ startup times, which is important as people install more and more Vim plugins.</p>
<p>So what kind of things can be safely autoloaded?  The answer is basically anything that’s not directly called by your users.  Mappings and custom commands can’t be autoloaded (because they wouldn’t be available for the users to call), but many other things can be.</p>
<p>Let’s look at our Potion plugin and see what we can autoload.</p>
<h2 id="Adding_Autoloading_to_the_Potion_Plugin">Adding Autoloading to the Potion Plugin</h2><p>We’ll start with the compile and run functionality.  Remember that our <code>ftplugin/potion/running.vim</code> file looked like this at the end of the previous chapter:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">if !exists("g:potion_command")</span><br><span class="line"></span><br><span class="line">let g:potion_command = "/Users/sjl/src/potion/potion"</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">function! PotionCompileAndRunFile()</span><br><span class="line"></span><br><span class="line">silent !clear</span><br><span class="line"></span><br><span class="line">execute "!" . g:potion_command . " " . bufname("%")</span><br><span class="line"></span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line">function! PotionShowBytecode()</span><br><span class="line"></span><br><span class="line">" Get the bytecode.</span><br><span class="line"></span><br><span class="line">let bytecode = system(g:potion_command . " -c -V " . bufname("%"))</span><br><span class="line"></span><br><span class="line">" Open a new split and set it up.</span><br><span class="line"></span><br><span class="line">vsplit __Potion_Bytecode__</span><br><span class="line"></span><br><span class="line">normal! ggdG</span><br><span class="line"></span><br><span class="line">setlocal filetype=potionbytecode</span><br><span class="line"></span><br><span class="line">setlocal buftype=nofile</span><br><span class="line"></span><br><span class="line">" Insert the bytecode.</span><br><span class="line"></span><br><span class="line">call append(0, split(bytecode, '\v\n'))</span><br><span class="line"></span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line">nnoremap &lt;buffer&gt; &lt;localleader&gt;r :call PotionCompileAndRunFile()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">nnoremap &lt;buffer&gt; &lt;localleader&gt;b :call PotionShowBytecode()&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>This file is already only called when a Potion file is loaded, so it doesn’t add to the overhead of Vim’s startup in general.  But there may be some users who simply don’t need this functionality, so if we can autoload some of it we’ll save them a few milliseconds every time they open a Potion file.</p>
<p>Yes, in this case the savings won’t be huge.  But I’m sure you can imagine a plugin with many thousands of lines of functions where the time required to load them would be more significant.</p>
<p>Let’s get started.  Create an <code>autoload/potion/running.vim</code> file in your plugin repo.  Then move the two functions into it and adjust their names, so they look like this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echom</span> <span class="string">"Autoloading..."</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">potion</span>#<span class="title">running</span>#<span class="title">PotionCompileAndRunFile</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">silent</span> !clear</span><br><span class="line"></span><br><span class="line"><span class="keyword">execute</span> <span class="string">"!"</span> . <span class="variable">g:potion_command</span> . <span class="string">" "</span> . <span class="built_in">bufname</span>(<span class="string">"%"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">potion</span>#<span class="title">running</span>#<span class="title">PotionShowBytecode</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="string">" Get the bytecode.</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">let</span> bytecode = <span class="built_in">system</span>(<span class="variable">g:potion_command</span> . <span class="string">" -c -V "</span> . <span class="built_in">bufname</span>(<span class="string">"%"</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">" Open a new split and set it up.</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">vsplit</span> __Potion_Bytecode__</span><br><span class="line"></span><br><span class="line">normal! ggdG</span><br><span class="line"></span><br><span class="line"><span class="keyword">setlocal</span> <span class="keyword">filetype</span>=potionbytecode</span><br><span class="line"></span><br><span class="line"><span class="keyword">setlocal</span> buftype=nofile</span><br><span class="line"></span><br><span class="line"><span class="string">" Insert the bytecode.</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">call</span> <span class="built_in">append</span>(<span class="number">0</span>, <span class="built_in">split</span>(bytecode, <span class="string">'\v\n'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>Notice how the <code>potion#running</code> portion of the function names matches the directory and file name where they live.  Now change the <code>ftplugin/potion/running.vim</code> file to look like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if !exists("g:potion_command")</span><br><span class="line"></span><br><span class="line">let g:potion_command = "/Users/sjl/src/potion/potion"</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">nnoremap &lt;buffer&gt; &lt;localleader&gt;r</span><br><span class="line"></span><br><span class="line">        \ :call potion#running#PotionCompileAndRunFile()&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">nnoremap &lt;buffer&gt; &lt;localleader&gt;b</span><br><span class="line"></span><br><span class="line">        \ :call potion#running#PotionShowBytecode()&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>Save the files, close Vim, and open up your <code>factorial.pn</code> file.  Try using the mappings to make sure they still work properly.</p>
<p>Make sure that you see the diagnostic <code>Autoloading...</code> message only the first time you run one of the mappings (you may need to use <code>:messages</code> to see it). Once you confirm that autoloading is working properly you can remove that message.</p>
<p>As you can see, we’ve left the <code>nnoremap</code> calls that map the keys.  We can’t autoload these because the user would have no way to initiate the autoloading if we did!</p>
<p>This is a common pattern you’ll see in Vim plugins: most of their functionality will be held in autoloaded functions, with just <code>nnoremap</code> and <code>command</code> commands in the files that Vim loads every time.  Keep it in mind whenever you’re writing a non-trivial Vim plugin.</p>
<h2 id="Exercises">Exercises</h2><p>Read <code>:help autoload</code>.</p>
<p>Experiment a bit and find out how autoloading variables behaves.</p>
<p>Suppose you wanted to programatically force a reload of an autoload file Vim has already loaded, without bothering the user.  How might you do this?  You may want to read <code>:help silent!</code>.  Please don’t ever do this in real life.</p>
<p><a href="52.html">« Previous</a><a style="float:right" href="54.html">Next »</a></p>

      
    </div>
    
  </div>
  
</article>


</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
	<div id="footer-info" class="inner">
	&copy; 2015 Yiming LU<br>
	Hosted on <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
	</div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'ymlu';
  
  var disqus_url = 'http://seasonsroad.com/LearnVimScriptTheHardWay/53.html';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

  </div>
</body>
</html>
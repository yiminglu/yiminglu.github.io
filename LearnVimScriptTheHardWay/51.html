<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Potion Section Movement | Yiming @ SeasonsRoad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Now that we know how section movement works, let’s remap the commands to work in a way that makes sense for Potion files.
First we need to decide what “section” should mean for a Potion file.  There a">
<meta property="og:type" content="website">
<meta property="og:title" content="Potion Section Movement">
<meta property="og:url" content="http://seasonsroad.com/LearnVimScriptTheHardWay/51.html">
<meta property="og:site_name" content="Yiming @ SeasonsRoad">
<meta property="og:description" content="Now that we know how section movement works, let’s remap the commands to work in a way that makes sense for Potion files.
First we need to decide what “section” should mean for a Potion file.  There a">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Potion Section Movement">
<meta name="twitter:description" content="Now that we know how section movement works, let’s remap the commands to work in a way that makes sense for Potion files.
First we need to decide what “section” should mean for a Potion file.  There a">
  
    <link rel="alternative" href="/atom.xml" title="Yiming @ SeasonsRoad" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-nav" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Good Morning!</a>
      </h1>
      <nav id="main-nav">
        <ul class="mod-head__ul">
        
          <li class="main-nav-link"><a href="/">Home</a></li>
        
          <li class="main-nav-link"><a href="/links.html">Links</a></li>
        
          <li class="main-nav-link"><a href="https://github.com/yiminglu">Github</a></li>
        
          <li class="main-nav-link"><a href="/about.html">About</a></li>
        
        </ul>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="inner">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      <a href="/LearnVimScriptTheHardWay/51.html">
        Potion Section Movement
      </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Now that we know how section movement works, let’s remap the commands to work in a way that makes sense for Potion files.</p>
<p>First we need to decide what “section” should mean for a Potion file.  There are two pairs of section movement commands, so we can come up with two “schemes” and our users can use the one they prefer.</p>
<p>Let’s use the following two schemes to define where Potion sections start:</p>
<ol>
<li>Any line following a blank line that contains non-whitespace as the first<br>character, or the first line in the file. 2. Any line that contains non-whitespace as the first character, an equal sign<br>somewhere inside the line, and ends with a colon.</li>
</ol>
<p>Using a slightly-expanded version of our sample <code>factorial.pn</code> file, here’s what these rules will consider to be section headers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># factorial.pn                              1&#10;&#10;# Print some factorials, just for fun.&#10;&#10;factorial = (n):                            1 2&#10;&#10;total = 1&#10;&#10;n to 1 (i):&#10;&#10;    total *= i.&#10;&#10;total.&#10;&#10;print_line = ():                            1 2&#10;&#10;&#34;-=-=-=-=-=-=-=-\n&#34; print.&#10;&#10;print_factorial = (i):                      1 2&#10;&#10;i string print&#10;&#10;&#39;! is: &#39; print&#10;&#10;factorial (i) string print&#10;&#10;&#34;\n&#34; print.&#10;&#10;&#34;Here are some factorials:\n\n&#34; print       1&#10;&#10;print_line ()                               1&#10;&#10;10 times (i):&#10;&#10;print_factorial (i).&#10;&#10;print_line ()</span><br></pre></td></tr></table></figure>
<p>Our first definition tends to be more liberal.  It defines a section to be roughly a “top-level chunk of text”.</p>
<p>The second definition is more restrictive.  It defines a section to be (effectively) a function definition.</p>
<h2 id="Custom_Mappings">Custom Mappings</h2><p>Create a <code>ftplugin/potion/sections.vim</code> file in your plugin’s repo.  This is where we’ll put the code for section movement.  Remember that this code will be run whenever a buffer’s <code>filetype</code> is set to <code>potion</code>.</p>
<p>We’re going to remap all four section movement commands, so go ahead and create a “skeleton” file:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">noremap</span> &lt;script&gt; &lt;<span class="keyword">buffer</span>&gt; &lt;<span class="keyword">silent</span>&gt; [[ &lt;nop&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">noremap</span> &lt;script&gt; &lt;<span class="keyword">buffer</span>&gt; &lt;<span class="keyword">silent</span>&gt; ]] &lt;nop&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">noremap</span> &lt;script&gt; &lt;<span class="keyword">buffer</span>&gt; &lt;<span class="keyword">silent</span>&gt; [] &lt;nop&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">noremap</span> &lt;script&gt; &lt;<span class="keyword">buffer</span>&gt; &lt;<span class="keyword">silent</span>&gt; ][ &lt;nop&gt;</span><br></pre></td></tr></table></figure>
<p>Notice that we use <code>noremap</code> commands instead of <code>nnoremap</code>, because we want these to work in operator-pending mode too.  That way you’ll be able to do things like <code>d]]</code> to “delete from here to the next section”.</p>
<p>We make the mappings buffer-local so they’ll only apply to Potion files and won’t take over globally.</p>
<p>We also make them silent, because the user won’t care about the details of how we move between sections.</p>
<h2 id="Using_a_Function">Using a Function</h2><p>The code for performing the section movements is going to be very similar for all of the various commands, so let’s abstract it into a function that our mappings will call.</p>
<p>You’ll see this strategy in a lot of Vim plugins that create a number of similar mappings.  It’s easier to read and maintain than stuffing all the functionality in to a bunch of mapping lines.</p>
<p>Change the <code>sections.vim</code> file to contain this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function! s:NextSection(type, backwards)</span><br><span class="line"></span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; ]]</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(1, 0)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; [[</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(1, 1)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; ][</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(2, 0)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; []</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(2, 1)&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>I used Vimscript’s long line continuation feature here because the lines were getting a bit long for my taste.  Notice how the backslash to escape long lines comes at the <em>beginning</em> of the second line.  Read <code>:help line-continuation</code> for more information.</p>
<p>Notice that we’re using <code>&lt;SID&gt;</code> and a script-local function to avoid polluting the global namespace with our helper function.</p>
<p>Each mapping simply calls <code>NextSection</code> with the appropriate arguments to perform the movement.  Now we can start implementing <code>NextSection</code>.</p>
<h2 id="Base_Movement">Base Movement</h2><p>Let’s think about what our function needs to do.  We want to move the cursor to the next “section”, and an easy way to move the cursor somewhere is with the <code>/</code> and <code>?</code> commands.</p>
<p>Edit <code>NextSection</code> to look like this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">s</span>:<span class="title">NextSection</span><span class="params">(type, backwards)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:backwards</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'?'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">execute</span> <span class="string">'silent normal! '</span> . dir . <span class="string">'foo'</span> . <span class="string">"\r"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>Now the function uses the <code>execute normal!</code> pattern we’ve seen before to perform either <code>/foo</code> or <code>?foo</code>, depending on the value given for <code>backwards</code>.  This is a good start.</p>
<p>Moving on, we’re obviously going to need to search for something other than <code>foo</code>, and that pattern is going to depend on whether we want to use the first or second definition of section headings.</p>
<p>Change <code>NextSection</code> to look like this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">s</span>:<span class="title">NextSection</span><span class="params">(type, backwards)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:type</span> == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pattern = <span class="string">'one'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> <span class="variable">a:type</span> == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pattern = <span class="string">'two'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:backwards</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'?'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">execute</span> <span class="string">'silent normal! '</span> . dir . pattern . <span class="string">"\r"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>Now we just need to fill in the patterns, so let’s go ahead and do that.</p>
<h2 id="Top_Level_Text_Sections">Top Level Text Sections</h2><p>Replace the first <code>let pattern = &#39;...&#39;</code> line with the following:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pattern = <span class="string">'\v(\n\n^\S|%^)'</span></span><br></pre></td></tr></table></figure>
<p>To understand how the regular expression works, remember the definition of “section” that we’re implementing:</p>
<blockquote>
<p>Any line following a blank line that contains a non-whitespace as the first &gt; character, or the first line in the file.</p>
</blockquote>
<p>The <code>\v</code> at the beginning simply forces “very magic” mode like we’ve seen several times before.</p>
<p>The remainder of the regex is a group with two options.  The first, <code>\n\n^\S</code>, searches for “a newline, followed by a newline, followed by a non-whitespace character”.  This finds the first set of lines in our definition.</p>
<p>The other option is <code>%^</code>, which is a special Vim regex atom that means “beginning of file”.</p>
<p>Now we’re at a point where we can try out the first two mappings.  Save <code>ftplugin/potion/sections.vim</code> and run <code>:set filetype=potion</code> in your sample Potion buffer.  The <code>[[</code> and <code>]]</code> commands should work, but somewhat oddly.</p>
<h2 id="Search_Flags">Search Flags</h2><p>You’ll notice that when you move between sections your cursor gets placed on the blank line above the one we actually want to move to.  Think about why this happens before reading on.</p>
<p>The answer is that we searched using <code>/</code> (or <code>?</code>) and by default Vim places your cursor at the beginning of matches.  For example, when you run <code>/foo</code> your cursor will be placed on the <code>f</code> in <code>foo</code>.</p>
<p>To tell Vim to put the cursor at the end of the match instead of the beginning, we can use a search flag.  Try searching in your Potion file like so:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/factorial/<span class="keyword">e</span></span><br></pre></td></tr></table></figure>
<p>Vim will find the word <code>factorial</code> and move you to it.  Press <code>n</code> a few times to move through the matches.  The <code>e</code> flag tells Vim to put the cursor at the end of matches instead of the beginning.  Try it in the other direction too:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?factorial?<span class="keyword">e</span></span><br></pre></td></tr></table></figure>
<p>Let’s modify our function to use a search flag to put our cursor on the other end of the matches for this section:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">s</span>:<span class="title">NextSection</span><span class="params">(type, backwards)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:type</span> == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pattern = <span class="string">'\v(\n\n^\S|%^)'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> flags = <span class="string">'e'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> <span class="variable">a:type</span> == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pattern = <span class="string">'two'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> flags = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:backwards</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'?'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">execute</span> <span class="string">'silent normal! '</span> . dir . pattern . dir . flags . <span class="string">"\r"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>We’ve changed two things here.  First, we set a <code>flags</code> variable depending on the type of section movement.  For now we only worry about the first type, which is going to need a flag of <code>e</code>.</p>
<p>Second, we’ve concatenated <code>dir</code> and <code>flags</code> to the search string.  This will add <code>?e</code> or <code>/e</code> depending on which direction we’re searching.</p>
<p>Save the file, switch back to your sample Potion file and run <code>:set ft=potion</code> to make the changes take effect.  Now try <code>[[</code> and <code>]]</code> to see them working properly!</p>
<h2 id="Function_Definitions">Function Definitions</h2><p>It’s time to tackle our second definition of “section”, and luckily this one is much more straightforward than the first.  Recall the definition we need to implement:</p>
<blockquote>
<p>Any line that contains a non-whitespace as the first character, an equal sign &gt; somewhere inside the line, and ends with a colon.</p>
</blockquote>
<p>We can use a fairly simple regex to find these lines.  Change the second <code>let pattern = &#39;...&#39;</code> line in the function to this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pattern = <span class="string">'\v^\S.*\=.*:$'</span></span><br></pre></td></tr></table></figure>
<p>This regex should look much less frightening than the last one.  I’ll leave it as an exercise for you to figure out how it works – it’s a pretty straightforward translation of our definition.</p>
<p>Save the file, run <code>:set filetype=potion</code> in <code>factorial.pn</code>, and try out the new <code>][</code> and <code>[]</code> mappings.  They should work as expected.</p>
<p>We don’t need a search flag here because putting the cursor at the beginning of the match (the default) works just fine.</p>
<h2 id="Visual_Mode">Visual Mode</h2><p>Our section movement commands work great in normal mode, but we need to add a bit more to make them work in visual mode as well.  First, change the function to look like this:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">s</span>:<span class="title">NextSection</span><span class="params">(type, backwards, visual)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:visual</span></span><br><span class="line"></span><br><span class="line">    normal! <span class="keyword">gv</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:type</span> == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pattern = <span class="string">'\v(\n\n^\S|%^)'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> flags = <span class="string">'e'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> <span class="variable">a:type</span> == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pattern = <span class="string">'\v^\S.*\=.*:$'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> flags = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">a:backwards</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'?'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dir = <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">execute</span> <span class="string">'silent normal! '</span> . dir . pattern . dir . flags . <span class="string">"\r"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>Two things have changed.  First, the function takes an extra argument so it knows whether it’s being called from visual mode or not.  Second, if it’s called from visual mode we run <code>gv</code> to restore the visual selection.</p>
<p>Why do we need to do this?  Let’s try something that will make it clear. Visually select some text in any buffer and then run the following command:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:echom "hello"</span><br></pre></td></tr></table></figure>
<p>Vim will display <code>hello</code> but the visual selection will also be cleared!</p>
<p>When running an ex mode command with <code>:</code> the visual selection is always cleared. The <code>gv</code> command reselects the previous visual selection, so this will “undo” the clearing.  It’s a useful command, and can be handy in your day-to-day work too.</p>
<p>Now we need to update the existing mappings to pass <code>0</code> in for the new <code>visual</code> argument:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; ]]</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(1, 0, 0)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; [[</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(1, 1, 0)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; ][</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(2, 0, 0)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">noremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; []</span><br><span class="line"></span><br><span class="line">    \ :call &lt;SID&gt;NextSection(2, 1, 0)&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>Nothing too complex there.  Now let’s add the visual mode mappings as the final piece of the puzzle:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vnoremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; ]]</span><br><span class="line"></span><br><span class="line">    \ :&lt;c-u&gt;call &lt;SID&gt;NextSection(1, 0, 1)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">vnoremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; [[</span><br><span class="line"></span><br><span class="line">    \ :&lt;c-u&gt;call &lt;SID&gt;NextSection(1, 1, 1)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">vnoremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; ][</span><br><span class="line"></span><br><span class="line">    \ :&lt;c-u&gt;call &lt;SID&gt;NextSection(2, 0, 1)&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">vnoremap &lt;script&gt; &lt;buffer&gt; &lt;silent&gt; []</span><br><span class="line"></span><br><span class="line">    \ :&lt;c-u&gt;call &lt;SID&gt;NextSection(2, 1, 1)&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>These mappings all pass <code>1</code> for the <code>visual</code> argument to tell Vim to reselect the last selection before performing the movement.  They also use the <code>&lt;c-u&gt;</code> trick we learned about in the Grep Operator chapters.</p>
<p>Save the file, <code>:set ft=potion</code> in the Potion file and you’re done!  Give your new mappings a try.  Things like <code>v]]</code> and <code>d[]</code> should all work properly now.</p>
<h2 id="Why_Bother?">Why Bother?</h2><p>This has been a long chapter for some seemingly small functionality, but you’ve learned and practiced a lot of useful things along the way:</p>
<ul>
<li>Using <code>noremap</code> instead of <code>nnoremap</code> to create mappings that work as<br>movements and motions. <em> Using a single function with several arguments to simplify creating related<br>mappings. </em> Building up functionality in a Vimscript function incrementally. <em> Building up an <code>execute &#39;normal! ...&#39;</code> string programmatically. </em> Using simple searches to move around with regexes. <em> Using special regex atoms like <code>%^</code> (beginning of file). </em> Using search flags to modify how searches work. * Handling visual mode mappings that need to retain the visual selection.</li>
</ul>
<p>Go ahead and do the exercises (it’s just a bit of <code>:help</code> reading) and then grab some ice cream.  You’ve earned it after this chapter!</p>
<h2 id="Exercises">Exercises</h2><p>Read <code>:help search()</code>.  This is a useful function to know, but you can also use the flags listed with the <code>/</code> and <code>?</code> commands.</p>
<p>Read <code>:help ordinary-atom</code> to learn about more interesting things you can use in search patterns.</p>
<p><a href="50.html">« Previous</a><a style="float:right" href="52.html">Next »</a></p>

      
    </div>
    
  </div>
  
</article>


</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
	<div id="footer-info" class="inner">
	&copy; 2016 Yiming LU<br>
	Hosted on <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
	</div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'ymlu';
  
  var disqus_url = 'http://seasonsroad.com/LearnVimScriptTheHardWay/51.html';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

  </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Case Study: Grep Operator, Part Two | Yiming @ SeasonsRoad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Now that we’ve got a preliminary sketch of our solution, it’s time to flesh it out into something powerful.
Remember: our original goal was to create a “grep operator”.  There are a whole bunch of new">
<meta property="og:type" content="website">
<meta property="og:title" content="Case Study: Grep Operator, Part Two">
<meta property="og:url" content="http://blog.seasonsroad.com/LearnVimScriptTheHardWay/33.html">
<meta property="og:site_name" content="Yiming @ SeasonsRoad">
<meta property="og:description" content="Now that we’ve got a preliminary sketch of our solution, it’s time to flesh it out into something powerful.
Remember: our original goal was to create a “grep operator”.  There are a whole bunch of new">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Case Study: Grep Operator, Part Two">
<meta name="twitter:description" content="Now that we’ve got a preliminary sketch of our solution, it’s time to flesh it out into something powerful.
Remember: our original goal was to create a “grep operator”.  There are a whole bunch of new">
  
    <link rel="alternative" href="/atom.xml" title="Yiming @ SeasonsRoad" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-nav" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Good Morning!</a>
      </h1>
      <nav id="main-nav">
        <ul class="mod-head__ul">
        
          <li class="main-nav-link"><a href="/">Home</a></li>
        
          <li class="main-nav-link"><a href="/links.html">Links</a></li>
        
          <li class="main-nav-link"><a href="https://github.com/yiminglu">Github</a></li>
        
          <li class="main-nav-link"><a href="/about.html">About</a></li>
        
        </ul>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="inner">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      <a href="/LearnVimScriptTheHardWay/33.html">
        Case Study: Grep Operator, Part Two
      </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Now that we’ve got a preliminary sketch of our solution, it’s time to flesh it out into something powerful.</p>
<p>Remember: our original goal was to create a “grep operator”.  There are a whole bunch of new things we need to cover to do this, but we’re going to follow the same process we did in the last chapter: start with something simple and transform it until it does what you need.</p>
<p>Before we start, comment out the mapping we creating the previous chapter from your <code>~/.vimrc</code> file – we’re going to use the same keystroke for our new operator.</p>
<h2 id="Create_a_File">Create a File</h2><p>Creating an operator will take a number of commands and typing those out by hand will get tedious very quickly.  You could add it to your <code>~/.vimrc</code> file, but let’s create a separate file just for this operator instead.  It’s meaty enough to warrant a file of its own.</p>
<p>First, find your Vim <code>plugin</code> directory.  On Linux or OS X this will be at <code>~/.vim/plugin</code>.  If you’re on Windows it will be inside the <code>vimfiles</code> directory in your home directory. (Use the command: <code>:echo $HOME</code> in Vim if you’re not sure where this is). If this directory doesn’t exist, create it.</p>
<p>Inside <code>plugin/</code> create a file named <code>grep-operator.vim</code>.  This is where you’ll place the code for this new operator.  When you’re editing the file you can run <code>:source %</code> to reload the code at any time.  This file will also be loaded each time you open Vim just like <code>~/.vimrc</code>.</p>
<p>Remember that you <em>must</em> write the file before you source it for the changes to be seen!</p>
<h2 id="Skeleton">Skeleton</h2><p>To create a new Vim operator you’ll start with two components: a function and a mapping.  Start by adding the following code to <code>grep-operator.vim</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;g :set operatorfunc=GrepOperator&lt;cr&gt;g@</span><br><span class="line"></span><br><span class="line">function! GrepOperator(type)</span><br><span class="line"></span><br><span class="line">echom "Test"</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Write the file and source it with <code>:source %</code>.  Try it out by pressing <code>&lt;leader&gt;giw</code> to say “grep inside word”.  Vim will echo <code>Test</code> <em>after</em> accepting the <code>iw</code> motion, which means we’ve laid out the skeleton.</p>
<p>The function is simple and nothing we haven’t seen before, but that mapping is a bit more complicated.  First we set the <code>operatorfunc</code> option to our function, and then we run <code>g@</code> which calls this function as an operator.  This may seem a bit convoluted, but it’s how Vim works.</p>
<p>For now it’s okay to consider this mapping to be black magic.  You can delve into the detailed documentation later.</p>
<h2 id="Visual_Mode">Visual Mode</h2><p>We’ve added the operator to normal mode, but we’ll want to be able to use it from visual mode as well.  Add another mapping below the first:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnoremap &lt;leader&gt;g :&lt;c-u&gt;call GrepOperator(visualmode())&lt;cr&gt;</span><br></pre></td></tr></table></figure>
<p>Write and source the file.  Now visually select something and press <code>&lt;leader&gt;g</code>. Nothing happens, but Vim does echo <code>Test</code>, so our function is getting called.</p>
<p>We’ve seen the <code>&lt;c-u&gt;</code> in this mapping before but never explained what it did. Try visually selecting some text and pressing <code>:</code>.  Vim will open a command line as it usually does when <code>:</code> is pressed, but it automatically fills in <code>&#39;&lt;,&#39;&gt;</code> at the beginning of the line!</p>
<p>Vim is trying to be helpful and inserts this text to make the command you’re about to run function on the visually selected range.  In this case, however, we don’t want the help.  We use <code>&lt;c-u&gt;</code> to say “delete from the cursor to the beginning of the line”, removing the text.  This leaves us with a bare <code>:</code>, ready for the <code>call</code> command.</p>
<p>The <code>call GrepOperator()</code> is simply a function call like we’ve seen before, but the <code>visualmode()</code> we’re passing as an argument is new.  This function is a built-in Vim function that returns a one-character string representing the last type of visual mode used: <code>&quot;v&quot;</code> for characterwise, <code>&quot;V&quot;</code> for linewise, and a <code>Ctrl-v</code> character for blockwise.</p>
<h2 id="Motion_Types">Motion Types</h2><p>The function we defined takes a <code>type</code> argument.  We know that when we use the operator from visual mode it will be the result of <code>visualmode()</code>, but what about when we run it as an operator from normal mode?</p>
<p>Edit the function body so the file looks like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;g :set operatorfunc=GrepOperator&lt;cr&gt;g@</span><br><span class="line"></span><br><span class="line">vnoremap &lt;leader&gt;g :&lt;c-u&gt;call GrepOperator(visualmode())&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! GrepOperator(type)</span><br><span class="line"></span><br><span class="line">echom a:type</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Source the file, then go ahead and try it out in a variety of ways.  Some examples of the output you get are:</p>
<ul>
<li>Pressing <code>viw&lt;leader&gt;g</code> echoes <code>v</code> because we were in characterwise visual<br>mode. <em> Pressing <code>Vjj&lt;leader&gt;g</code> echoes <code>V</code> because we were in linewise visual mode. </em> Pressing <code>&lt;leader&gt;giw</code> echoes <code>char</code> because we used a characterwise motion<br>with the operator. * Pressing <code>&lt;leader&gt;gG</code> echoes <code>line</code> because we used a linewise motion with the<br>operator.</li>
</ul>
<p>Now we know how we can tell the difference between motion types, which will be important when we select the text to search for.</p>
<h2 id="Copying_the_Text">Copying the Text</h2><p>Our function is going to need to somehow get access to the text the user wants to search for, and the easiest way to do that is to simply copy it.  Edit the function to look like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;g :set operatorfunc=GrepOperator&lt;cr&gt;g@</span><br><span class="line"></span><br><span class="line">vnoremap &lt;leader&gt;g :&lt;c-u&gt;call GrepOperator(visualmode())&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! GrepOperator(type)</span><br><span class="line"></span><br><span class="line">if a:type ==# 'v'</span><br><span class="line"></span><br><span class="line">    execute "normal! `&lt;v`&gt;y"</span><br><span class="line"></span><br><span class="line">elseif a:type ==# 'char'</span><br><span class="line"></span><br><span class="line">    execute "normal! `[v`]y"</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">    return</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">echom @@</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>Wow.  That’s a lot of new stuff.  Try it out by pressing things like <code>&lt;leader&gt;giw</code>, <code>&lt;leader&gt;g2e</code> and <code>vi(&lt;leader&gt;g</code>.  Each time Vim will echo the text that the motion covers, so clearly we’re making progress!</p>
<p>Let’s break this new code down one step at a time.  First we have an <code>if</code> statement that checks the <code>a:type</code> argument.  If the type is <code>&#39;v&#39;</code> it was called from characterwise visual mode, so we do something to copy the visually-selected text.</p>
<p>Notice that we use the case-sensitive comparison <code>==#</code>.  If we used plain <code>==</code> and the user has <code>ignorecase</code> set it would match <code>&quot;V&quot;</code> as well, which is <em>not</em> what we want.  Code defensively!</p>
<p>The second case of the <code>if</code> fires if the operator was called from normal mode using a characterwise motion.</p>
<p>The final case simply returns.  We explicitly ignore the cases of linewise/blockwise visual mode and linewise/blockwise motions.  Grep doesn’t search across lines by default, so having a newline in the search pattern doesn’t make any sense!</p>
<p>Each of our two <code>if</code> cases runs a <code>normal!</code> command that does two things:</p>
<ul>
<li><p>Visually select the range of text we want by:</p>
</li>
<li><p>Moving to mark at the beginning of the range.</p>
</li>
<li><p>Entering characterwise visual mode.</p>
</li>
<li><p>Moving to the mark at the end of the range. * Yanking the visually selected text.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;Don&#39;t worry about the specific marks for now.  You&#39;ll learn why they need to be different when you complete the exercises at the end of this chapter.&#10;&#10;The final line of the function echoes the variable `@@`.  Remember that variables starting with an `@` are registers.  `@@` is the &#34;unnamed&#34; register: the one that Vim places text into when you yank or delete without specify a particular register.&#10;&#10;In a nutshell: we select the text to search for, yank it, then echo the yanked text.&#10;&#10;Escaping the Search Term&#10;------------------------&#10;&#10;Now that we&#39;ve got the text we need in a Vim string we can escape it like we did in the previous chapter.  Modify the `echom` command so it looks like this:&#10;&#10;````vim&#10;nnoremap &#60;leader&#62;g :set operatorfunc=GrepOperator&#60;cr&#62;g@&#10;&#10;vnoremap &#60;leader&#62;g :&#60;c-u&#62;call GrepOperator(visualmode())&#60;cr&#62;&#10;&#10;function! GrepOperator(type)&#10;&#10;if a:type ==# &#39;v&#39;&#10;&#10;    normal! `&#60;v`&#62;y&#10;&#10;elseif a:type ==# &#39;char&#39;&#10;&#10;    normal! `[v`]y&#10;&#10;else&#10;&#10;    return&#10;&#10;endif&#10;&#10;echom shellescape(@@)&#10;&#10;endfunction</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Write and source the file and try it out by visually selecting some text with a special character in it and pressing <code>&lt;leader&gt;g</code>.  Vim will echo a version of the selected text suitable for passing to a shell command.</p>
<h2 id="Running_Grep">Running Grep</h2><p>We’re finally ready to add the <code>grep!</code> command that will perform the actual search.  Replace the <code>echom</code> line so the code looks like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">nnoremap &lt;leader&gt;g :set operatorfunc=GrepOperator&lt;cr&gt;g@</span><br><span class="line"></span><br><span class="line">vnoremap &lt;leader&gt;g :&lt;c-u&gt;call GrepOperator(visualmode())&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">function! GrepOperator(type)</span><br><span class="line"></span><br><span class="line">if a:type ==# 'v'</span><br><span class="line"></span><br><span class="line">    normal! `&lt;v`&gt;y</span><br><span class="line"></span><br><span class="line">elseif a:type ==# 'char'</span><br><span class="line"></span><br><span class="line">    normal! `[v`]y</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">    return</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">silent execute "grep! -R " . shellescape(@@) . " ."</span><br><span class="line"></span><br><span class="line">copen</span><br><span class="line"></span><br><span class="line">endfunction</span><br></pre></td></tr></table></figure>
<p>This should look familiar.  We simply execute the <code>silent execute &quot;grep! ...&quot;</code> command we came up with in the last chapter.  It’s even more readable here because we’re not trying to stuff the entire thing into a <code>nnoremap</code> command!</p>
<p>Write and source the file, then try it out and enjoy the fruits of your labor!</p>
<p>Because we’ve defined a brand new Vim operator we can use it in a lot of different ways, such as:</p>
<ul>
<li><code>viw&lt;leader&gt;g</code>: Visually select a word, then grep for it. <em> <code>&lt;leader&gt;g4w</code>: Grep for the next four words. </em> <code>&lt;leader&gt;gt;</code>: Grep until semicolon. * <code>&lt;leader&gt;gi[</code>: Grep inside square brackets.</li>
</ul>
<p>This highlights one of the best things about Vim: its editing commands are like a language.  When you add a new verb it automatically works with (most of) the existing nouns and adjectives.</p>
<h2 id="Exercises">Exercises</h2><p>Read <code>:help visualmode()</code>.</p>
<p>Read <code>:help c_ctrl-u</code>.</p>
<p>Read <code>:help operatorfunc</code>.</p>
<p>Read <code>:help map-operator</code>.</p>
<p><a href="32.html">« Previous</a><a style="float:right" href="34.html">Next »</a></p>

      
    </div>
    
  </div>
  
</article>


</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
	<div id="footer-info" class="inner">
	&copy; 2016 Yiming LU<br>
	Hosted on <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
	</div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'ymlu';
  
  var disqus_url = 'http://blog.seasonsroad.com/LearnVimScriptTheHardWay/33.html';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

  </div>
</body>
</html>